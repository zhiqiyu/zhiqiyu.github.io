<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Same-day Landsat-8 and Sentinel-2 Pair Generation on GEE</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.57.2" />
	<meta property="og:title" content="Same-day Landsat-8 and Sentinel-2 Pair Generation on GEE" />
<meta property="og:description" content="This notebook presents a data preparation workflow that finds same-date and overlapped Landsat8 and Sentinel2 image patches and provide a way to download the processed images to the local machine.
This is a part of the ongoing research project Landsat2Sentinel.
The whole notebook is available on my Github repository.
import ee ee.Initialize() from IPython import display import zipfile import urllib from ipywidgets import IntProgress  Function for downloading images from GEE def download_tif(image, scale, name, folder): url = ee." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhiqiyu.github.io/post/landsat-sentinel-match/" />
<meta property="article:published_time" content="2019-02-13T15:20:20-05:00" />
<meta property="article:modified_time" content="2019-02-13T15:20:20-05:00" />

	<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Same-day Landsat-8 and Sentinel-2 Pair Generation on GEE"/>
<meta name="twitter:description" content="This notebook presents a data preparation workflow that finds same-date and overlapped Landsat8 and Sentinel2 image patches and provide a way to download the processed images to the local machine.
This is a part of the ongoing research project Landsat2Sentinel.
The whole notebook is available on my Github repository.
import ee ee.Initialize() from IPython import display import zipfile import urllib from ipywidgets import IntProgress  Function for downloading images from GEE def download_tif(image, scale, name, folder): url = ee."/>

	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="shortcut icon" href="/img/favicon-96.png">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-128672710-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<link rel="stylesheet" href="https://zhiqiyu.github.io/css/xcode.css" rel="stylesheet" id="theme-stylesheet">
	<script src="https://zhiqiyu.github.io/js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

	<div class="container">
		<div class="logo" role="banner">
			<a class="logo__link" href="/" title="ZQ.Yu" rel="home">
				<div class="logo__title">ZQ.Yu</div>
				<div class="logo__tagline">Geospatial data explorer, Deep learning enthusiast</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">Blog</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">About</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<section class="primary">
			
<main class="main" role="main">
	<article class="post">
		
		<header class="post__header">
			<h1 class="post__title">Same-day Landsat-8 and Sentinel-2 Pair Generation on GEE</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
	<time class="meta__text" datetime="2019-02-13T15:20:20">February 13, 2019</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/technical" rel="category">Technical</a>, <a class="meta__link" href="/categories/research" rel="category">Research</a></span>
</div>
</div>
		
		</header><div class="content post__content clearfix">
			

<p>This notebook presents a data preparation workflow that finds same-date and overlapped Landsat8 and Sentinel2 image patches and provide a way to download the processed images to the local machine.</p>

<p>This is a part of the ongoing research project <strong>Landsat2Sentinel</strong>.</p>

<p>The whole notebook is available on my Github repository.</p>

<pre><code class="language-python">import ee
ee.Initialize()

from IPython import display
import zipfile
import urllib
from ipywidgets import IntProgress
</code></pre>

<h2 id="function-for-downloading-images-from-gee">Function for downloading images from GEE</h2>

<pre><code class="language-python">def download_tif(image, scale, name, folder):
    url = ee.data.makeDownloadUrl(ee.data.getDownloadId({
        'image': image.serialize(),
        'scale': '%d' % scale,
        'filePerBand': 'false',
        'name': name,
    }))
    local_zip, header = urllib.request.urlretrieve(url)
    with zipfile.ZipFile(local_zip) as local_zipfile:
        return local_zipfile.extract(name + '.tif', folder)
</code></pre>

<h2 id="functions-used-in-the-process">Functions used in the process</h2>

<pre><code class="language-python">#===============================
def mapAddDates(img):
    '''
    The function used to map over Sentinel2 images to add a date attribute, 
    and rename the NIR band from 'B8' to 'B5' to match the naming convention of Landsat
    '''
    date_time = ee.Date(img.get('GENERATION_TIME'))
    return img.set('DATE', date_time.format('yyyy-MM-dd')).rename(['B2', 'B3', 'B4', 'B5'])

def getSameDateWithGeom(l8, sent, geom):
    '''
    Find pairs of Landsat8 and Sentinel2 images that are acquired in the same day
    and their footprints intersect with the input geometry
    '''
    l8pool = l8.filterBounds(geom).sort('DATE_ACQUIRED') \
                .filterMetadata('CLOUD_COVER', 'less_than', 10) \ # cloud cover limit set to 10%
                 .select('B[2-5]')                                # only use R,G,B,NIR bands
    sentpool = sent.filterBounds(geom).sort('GENERATION_TIME') \
                    .filterMetadata('CLOUDY_PIXEL_PERCENTAGE', 'less_than', 10) \
                     .filterMetadata('PROCESSING_BASELINE', 'not_ends_with', '2') \
                     .select('B[2-4|8]') \
                     .map(mapAddDates)

    eqfilter = ee.Filter.equals(leftField='DATE_ACQUIRED', rightField='DATE')
    innerjoin = ee.Join.inner()
    matches = innerjoin.apply(l8pool, sentpool, eqfilter)

    return matches
#===============================


def getRandomPoints(bound, num):
    '''
    Generate random points from the input boundary (for simplity, we used convex hull of the input boundary)
    '''
    points = ee.FeatureCollection.randomPoints(bound.geometry().convexHull(), num)
    return points
</code></pre>

<h2 id="main-process">Main Process</h2>

<pre><code class="language-python">##### Import imagery and boundary #####
l8toa = ee.ImageCollection('LANDSAT/LC08/C01/T1_TOA')
sent2 = ee.ImageCollection('COPERNICUS/S2')
boundary = ee.FeatureCollection('users/CSISS_LCLUC/studyarea_V4')
</code></pre>

<pre><code class="language-python">##### Generate square patch around random points #######
points = ee.FeatureCollection.randomPoints(boundary.geometry().convexHull(), 200, seed=10)

#===================
def mapGetPatch(pt):
    return pt.buffer(128*10).bounds()

patches = points.map(mapGetPatch)
</code></pre>

<h3 id="get-the-matched-image-pairs-of-landsat8-and-sentinel2">Get the matched image pairs of Landsat8 and Sentinel2</h3>

<p>The <code>match_collection</code> has the following structure (each level to the next level is a one-to-many relationship):
- FeatureCollection (random points)
    - FeatureCollection (pairs with different date for the given point)
        - Feature <code>{'primary': landsat8 image, 'secondary': sentinel2 image}</code></p>

<pre><code class="language-python"># Get the same date image pairs
def mapGetMatches(pts):
    def mapClipImageToPatch(f):
        l8_cand = ee.Image(f.get('primary'))
        sent_cand = ee.Image(f.get('secondary'))
        l8_clip = l8_cand.clipToBoundsAndScale(geometry=pts.geometry(), width=256, height=256)      # Fixed image size
        sent2_clip = sent_cand.clipToBoundsAndScale(geometry=pts.geometry(), width=256, height=256) 
#         intersection = l8_clip.geometry().intersection(sent2_clip.geometry())
        return f.set('primary', l8_clip).set('secondary', sent2_clip)
    
    match = getSameDateWithGeom(l8toa, sent2, pts.geometry())
    match_clip = match.map(mapClipImageToPatch)
    return match_clip
#-------------------------------------------

match_collection = patches.map(mapGetMatches)
</code></pre>

<pre><code class="language-python">####### Remove matches that no image pairs are found ######

match_list = match_collection.toList(match_collection.size())

#=================================
def mapDropNull(f):
    f = ee.FeatureCollection(f)
    return ee.Algorithms.If(f.size().eq(0), None, f)

pairs_list = match_list.map(mapDropNull)
#================================

pairs_list = pairs_list.removeAll(ee.List([None]))
</code></pre>

<h3 id="download-images">Download Images</h3>

<pre><code class="language-python">num_pairs = pairs_list.length().getInfo()
num_pairs
</code></pre>

<pre><code>180
</code></pre>

<pre><code class="language-python">bar = IntProgress(min=0, max=num_pairs)
display.display(bar)

for i in range(155, num_pairs):
    pairs = ee.FeatureCollection(pairs_list.get(i))
    num_pair = pairs.size().getInfo()
    pair_list = pairs.toList(num_pair)
    for j in range(num_pair):
        pair = ee.Feature(pair_list.get(j))
        primary = ee.Image(pair.get('primary'))
        secondary = ee.Image(pair.get('secondary')).divide(10000)   # Scale down the Sentinel2 pixel values to [0,1]
        download_tif(primary, 10, 'l', 'data/'+str(i)+'_'+str(j)+'/')
        download_tif(secondary, 10, 's', 'data/'+str(i)+'_'+str(j)+'/')
    bar.value = i
</code></pre>

		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16"><path d="M16 9.5c0 .373-.24.74-.5 1l-5 5c-.275.26-.634.5-1 .5-.373 0-.74-.24-1-.5L1 8a2.853 2.853 0 0 1-.7-1C.113 6.55 0 5.973 0 5.6V1.4C0 1.034.134.669.401.401.67.134 1.034 0 1.4 0h4.2c.373 0 .95.113 1.4.3.45.187.732.432 1 .7l7.5 7.502c.26.274.5.632.5.998zM3.5 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/gee/" rel="tag">GEE</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/remote-sensing/" rel="tag">Remote Sensing</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/deep-learning/" rel="tag">Deep Learning</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/python/" rel="tag">Python</a></li>
	</ul>
</div>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Zhiqi Yu avatar" src="/img/avatar.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Zhiqi Yu</span>
	</div>
	<div class="authorbox__description">
		Ph.D. student in Geoinformation Science
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/conv-fc-conversion/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">What are Fully-Connected Layers (FCN) in Convolutional Neural Networks (CNN)?</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/undef-symbol-pytorch/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">&#39;Undefined Symbol: PySlice_Unpack&#39; error in Pytorch</p></a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "realm-z" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</section>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Zhiqi Yu.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>